name: Build unsigned IPA

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve Swift packages
        run: xcodebuild -workspace KeePassium.xcworkspace -scheme KeePassium -resolvePackageDependencies

      - name: Create build dir
        run: mkdir -p build

      - name: Archive (unsigned)
        run: |
          xcodebuild \
            -workspace KeePassium.xcworkspace \
            -scheme KeePassium \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath build/KeePassium.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            archive

      - name: Create IPA
        run: |
          APP_PATH=$(find build/KeePassium.xcarchive -name "*.app" -type d | head -n 1)
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          cd Payload
          cd ..
          zip -r KeePassium.ipa Payload
          mv KeePassium.ipa build/

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: KeePassium-unsigned
          path: build/*.ipa
